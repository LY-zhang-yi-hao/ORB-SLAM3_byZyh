# ORB-SLAM3 ä¸­è‡ªå®šä¹‰åæ ‡ç³»ä¸ä½å§¿è·å–çš„æ·±åº¦è§£æä¸ä¼˜åŒ– ğŸš€

## 1. ğŸ¯ å¼•è¨€ï¼šç›®æ ‡ä¸èƒŒæ™¯

æœ¬æ–‡æ¡£æ—¨åœ¨æ·±å…¥åˆ†æåœ¨ ORB-SLAM3 ç³»ç»Ÿä¸­ï¼Œå¦‚ä½•å®ç°ä¸€ä¸ªç¨³å®šã€é«˜æ•ˆã€å¯æ‰©å±•çš„æ¨¡å—ï¼Œç”¨äºå®æ—¶è·å–ç›¸æœºåœ¨**è‡ªå®šä¹‰ä¸–ç•Œåæ ‡ç³»**ä¸‹çš„ä½å§¿ã€‚

#### æ ¸å¿ƒé—®é¢˜
1.  **è·å–æ—¶æœº**: åœ¨ `Tracking` çº¿ç¨‹å¤æ‚çš„è·Ÿè¸ªæµç¨‹ä¸­ï¼Œä½•æ—¶æ˜¯è·å–ä½å§¿çš„"æœ€ä½³"æ—¶æœºï¼Ÿ
2.  **åæ ‡å˜æ¢**: å¦‚ä½•æ­£ç¡®åœ°å°† SLAM å†…éƒ¨ä½å§¿è½¬æ¢åˆ°æˆ‘ä»¬æŒ‡å®šçš„è‡ªå®šä¹‰åæ ‡ç³»ä¸‹ï¼Ÿ

#### è®¾è®¡æ–¹æ¡ˆ
- æˆ‘ä»¬å°†é‡‡ç”¨ç»å…¸çš„ **è§‚å¯Ÿè€…ï¼ˆObserverï¼‰è®¾è®¡æ¨¡å¼**ã€‚
- `Tracking` çº¿ç¨‹ä½œä¸º**è¢«è§‚å¯Ÿè€…ï¼ˆSubjectï¼‰**ï¼Œåœ¨è®¡ç®—å‡ºæ¯å¸§çš„æœ‰æ•ˆä½å§¿åï¼Œè´Ÿè´£è¿›è¡Œåæ ‡å˜æ¢ï¼Œå¹¶é€šçŸ¥æ‰€æœ‰å·²æ³¨å†Œçš„**è§‚å¯Ÿè€…ï¼ˆObserverï¼‰**ã€‚

---

## 2. ğŸ§  æ ¸å¿ƒè·Ÿè¸ªæµç¨‹ï¼š`Tracking` çº¿ç¨‹å¦‚ä½•è®¡ç®—ä½å§¿ï¼Ÿ

è¦è·å–ä½å§¿ï¼Œé¦–å…ˆå¿…é¡»ç†è§£ä½å§¿æ˜¯å¦‚ä½•äº§ç”Ÿçš„ã€‚è¿™éƒ¨åˆ†å°†ä»¥å•ç›®ä¸ºä¾‹ï¼Œè¯¦ç»†å‰–æ `GrabImageMonocular` æ–¹æ³•è¿”å›çš„ä½å§¿çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸã€‚

### 2.1. å…¥å£ç‚¹: `System::TrackMonocular`

å¤–éƒ¨é€šè¿‡è°ƒç”¨ `System` ç±»çš„ `TrackMonocular` ç­‰æ–¹æ³•ï¼Œå°†å›¾åƒå’Œä¼ æ„Ÿå™¨æ•°æ®é€å…¥ SLAM ç³»ç»Ÿã€‚

![image.png](https://bu.dusays.com/2025/06/05/68419d9a23f14.png)

### 2.2. æ•°æ®å°è£…: `Tracking::GrabImageMonocular`

`System` ç±»çš„æ–¹æ³•ä¼šè¿›ä¸€æ­¥è°ƒç”¨ `Tracking` çº¿ç¨‹å¯¹åº”çš„ `GrabImageMonocular` æ–¹æ³•ã€‚

![image.png](https://bu.dusays.com/2025/06/05/68419ef702d7a.png)

æ­¤æ–¹æ³•ä¸»è¦å®Œæˆä¸‰ä»¶äº‹ï¼š
1.  **æ•°æ®å°è£…**: å°†å›¾åƒã€æ—¶é—´æˆ³ç­‰ä¿¡æ¯å°è£…æˆä¸€ä¸ª `Frame` å¯¹è±¡ï¼Œå³ `mCurrentFrame`ã€‚
2.  **è°ƒç”¨æ ¸å¿ƒ**: è°ƒç”¨ `Tracking::Track()` æ–¹æ³•ï¼Œè¿™æ˜¯æ‰€æœ‰è·Ÿè¸ªé€»è¾‘çš„æ ¸å¿ƒã€‚`Track()` æ‰§è¡Œå®Œæ¯•åï¼Œ`mCurrentFrame` çš„ä½å§¿ `mTcw` å°†è¢«æ›´æ–°ã€‚
3.  **è¿”å›ä½å§¿**: æ–¹æ³•æœ€åè¿”å› `mCurrentFrame.GetPoseInverse()`ï¼Œå³ `mCurrentFrame.mTwc`ã€‚è¿™æ˜¯**ç›¸æœºåœ¨ORB-SLAMä¸–ç•Œåæ ‡ç³»ä¸‹çš„ä½å§¿** (T_world_camera)ã€‚

> [!NOTE]
> **åæ ‡ç³»æœ¯è¯­æ¾„æ¸…**:
> * `mTcw`: å°†**ä¸–ç•Œåæ ‡ç³»**ä¸‹çš„ç‚¹å˜æ¢åˆ°**ç›¸æœºåæ ‡ç³»**çš„å˜æ¢çŸ©é˜µã€‚
> * `mTwc`: `mTcw` çš„é€†ï¼Œè¡¨ç¤º**ç›¸æœºåœ¨ä¸–ç•Œåæ ‡ç³»ä¸­çš„ä½å§¿**ï¼Œå³å°†ç›¸æœºåæ ‡ç³»ä¸‹çš„ç‚¹å˜æ¢åˆ°ä¸–ç•Œåæ ‡ç³»ã€‚
> * `Frame::GetPose()` è¿”å› `mTcw`ã€‚
> * `Frame::GetPoseInverse()` è¿”å› `mTwc`ã€‚

### 2.3. è·Ÿè¸ªæ ¸å¿ƒ: `Tracking::Track()` è¯¦è§£

`Track()` æ–¹æ³•æ˜¯æ•´ä¸ªè·Ÿè¸ªè¿‡ç¨‹çš„å¿ƒè„ã€‚å®ƒæ˜¯ä¸€ä¸ªçŠ¶æ€æœºï¼Œæ ¹æ®ç³»ç»Ÿå½“å‰çŠ¶æ€ï¼ŒæŒ‰é¡ºåºå°è¯•ä¸åŒçš„ç­–ç•¥æ¥ä¸º `mCurrentFrame` å®šä½ã€‚

![image.png](https://bu.dusays.com/2025/06/05/68419fb998cf0.png)

- **çŠ¶æ€ 1ï¼šç³»ç»Ÿæœªåˆå§‹åŒ– (NOT_INITIALIZED)**
  - å°è¯•è¿›è¡Œå•ç›®åˆå§‹åŒ– (`MonocularInitialization`)ï¼Œè®¡ç®—åˆå§‹ä½å§¿å’Œåœ°å›¾ã€‚

- **çŠ¶æ€ 2ï¼šç³»ç»Ÿå·²åˆå§‹åŒ– (OK)**
  1.  **IMU é¢„ç§¯åˆ† (è‹¥æœ‰)**: åˆ©ç”¨ IMU æ•°æ®é¢„æµ‹å½“å‰å¸§çš„åˆå§‹ä½å§¿ã€‚
  2.  **è¿åŠ¨æ¨¡å‹è·Ÿè¸ª (`TrackWithMotionModel`)**: åŸºäºä¸Šä¸€å¸§çš„é€Ÿåº¦é¢„æµ‹å½“å‰ä½å§¿ï¼Œå¹¶ä¸ä¸Šä¸€å¸§çš„åœ°å›¾ç‚¹è¿›è¡Œå¿«é€ŸåŒ¹é…ã€‚è¿™æ˜¯æœ€ç†æƒ³ã€æœ€é«˜æ•ˆçš„æƒ…å†µã€‚
  3.  **å‚è€ƒå…³é”®å¸§è·Ÿè¸ª (`TrackReferenceKeyFrame`)**: å¦‚æœè¿åŠ¨æ¨¡å‹è·Ÿè¸ªå¤±è´¥ï¼Œåˆ™å°è¯•ä¸æœ€è¿‘çš„å…³é”®å¸§è¿›è¡ŒåŒ¹é…å®šä½ã€‚
  4.  **å±€éƒ¨åœ°å›¾è·Ÿè¸ª (`TrackLocalMap`)**: **è¿™æ˜¯æœ€å…³é”®çš„ä½å§¿ä¼˜åŒ–æ­¥éª¤**ã€‚
     -  ç³»ç»Ÿä¼šæ„å»ºä¸€ä¸ªç”±é™„è¿‘å…³é”®å¸§åŠå…¶è§‚æµ‹åˆ°çš„åœ°å›¾ç‚¹ç»„æˆçš„"å±€éƒ¨åœ°å›¾"ã€‚
     -  å°†å½“å‰å¸§çš„ç‰¹å¾ç‚¹ä¸å±€éƒ¨åœ°å›¾ä¸­çš„æ‰€æœ‰ç‚¹è¿›è¡ŒåŒ¹é…ï¼Œå¹¶é€šè¿‡ BA ä¼˜åŒ–ï¼ˆ`Optimizer::PoseOptimization`ï¼‰æ¥æœ€å°åŒ–é‡æŠ•å½±è¯¯å·®ã€‚
     -  è¿™ä¸€æ­¥æå¤§åœ°æé«˜äº†ä½å§¿çš„å‡†ç¡®æ€§å’Œé²æ£’æ€§ï¼Œå› ä¸ºå®ƒåˆ©ç”¨äº† `LocalMapping` çº¿ç¨‹ä¼˜åŒ–è¿‡çš„å±€éƒ¨åœ°å›¾ä¿¡æ¯ï¼Œè€Œéå­¤ç«‹åœ°å¤„ç†å½“å‰å¸§ã€‚
  5.  **é‡å®šä½ (`Relocalization`)**: å¦‚æœä»¥ä¸Šæ‰€æœ‰æ–¹æ³•éƒ½å¤±è´¥ï¼ˆå³è·Ÿè¸ªä¸¢å¤± `mState == LOST`ï¼‰ï¼Œç³»ç»Ÿä¼šå¯åŠ¨é‡å®šä½æ¨¡å—ï¼Œå°è¯•åœ¨æ•´ä¸ªåœ°å›¾ä¸­é‡æ–°æ‰¾åˆ°è‡ªå·±çš„ä½ç½®ã€‚

#### ç»“è®º
> [!success]
> `GrabImage...` æ–¹æ³•è¿”å›çš„ä½å§¿ `mCurrentFrame.mTwc`ï¼Œæ˜¯åœ¨ `Track()` æ–¹æ³•ä¸­ç»è¿‡ä¸Šè¿°ä¸€ç³»åˆ—æ­¥éª¤ï¼ˆç‰¹åˆ«æ˜¯ `TrackLocalMap` ä¼˜åŒ–ï¼‰åå¾—åˆ°çš„ **`Tracking` çº¿ç¨‹å¯¹å½“å‰å¸§ä½å§¿çš„æœ€ä½³ä¼°è®¡**ã€‚å¯¹äºéœ€è¦å®æ—¶å“åº”çš„åº”ç”¨ï¼ˆå¦‚æœºå™¨äººå¯¼èˆªï¼‰ï¼Œè¿™ä¸ªä½å§¿æ˜¯æœ€æ–°ä¸”æœ€å¯é çš„ã€‚

---

## 3. ğŸŒ "æœ€ç»ˆä½å§¿"çš„ç›¸å¯¹æ€§ï¼šå¤šçº¿ç¨‹è§†è§’

ORB-SLAM3 æ˜¯ä¸€ä¸ªå…¸å‹çš„å¤šçº¿ç¨‹ç³»ç»Ÿï¼ˆ`Tracking`, `LocalMapping`, `LoopClosing`ï¼‰ã€‚ç†è§£çº¿ç¨‹é—´çš„å…³ç³»ï¼Œå¯¹äºç†è§£ä½å§¿çš„"æœ€ç»ˆæ€§"è‡³å…³é‡è¦ã€‚

- **`Tracking` çº¿ç¨‹**: è¿½æ±‚**å®æ—¶æ€§**ã€‚å®ƒäº§å‡ºçš„ä½å§¿æ˜¯å®æ—¶çš„ï¼Œä½†ä¸æ˜¯å…¨å±€æœ€ä¼˜çš„ã€‚
- **`LocalMapping` çº¿ç¨‹**: è´Ÿè´£å°†æ–°çš„å…³é”®å¸§åŠ å…¥åœ°å›¾ï¼Œå¹¶è¿›è¡Œå±€éƒ¨ BA ä¼˜åŒ–ï¼Œä½¿å±€éƒ¨åŒºåŸŸçš„åœ°å›¾å’Œå…³é”®å¸§ä½å§¿æ›´ç²¾ç¡®ã€‚
- **`LoopClosing` çº¿ç¨‹**: å½“æ£€æµ‹åˆ°å›ç¯æ—¶ï¼Œä¼šè¿›è¡Œä½å§¿å›¾ä¼˜åŒ–å’Œå…¨å±€ BAã€‚è¿™ä¼š**å…¨å±€æ€§åœ°ä¿®æ­£**è¿‡å»æ‰€æœ‰å…³é”®å¸§çš„ä½å§¿ã€‚è¿™ç§ä¿®æ­£æ˜¯**å›é¡¾æ€§**çš„ï¼Œä¼šå¸¦æ¥åœ°å›¾å’Œè½¨è¿¹çš„æ•´ä½“ç²¾åº¦æå‡ï¼Œä½†ä¹Ÿä¼šå¯¼è‡´ä½å§¿çš„"è·³å˜"ã€‚

> [!tip]
> - å¯¹äº**å®æ—¶åº”ç”¨**ï¼ˆå¦‚å¯¼èˆªã€ARï¼‰ï¼Œ`Tracking` çº¿ç¨‹è¾“å‡ºçš„ä½å§¿æ˜¯å”¯ä¸€å¯ç”¨ä¸”æœ€ä½³çš„é€‰æ‹©ã€‚
> - å¯¹äº**ç¦»çº¿åº”ç”¨**ï¼ˆå¦‚ä¸‰ç»´é‡å»ºï¼‰ï¼Œåº”åœ¨ SLAM è¿è¡Œç»“æŸåï¼Œä» `KeyFrameDatabase` ä¸­è·å–ç»è¿‡å…¨å±€ä¼˜åŒ–åçš„æœ€ç»ˆè½¨è¿¹ã€‚

---

## 4. ğŸ› ï¸ å®ç°æ–¹æ¡ˆï¼šåŸºäºè§‚å¯Ÿè€…æ¨¡å¼çš„ä½å§¿å‘å¸ƒç³»ç»Ÿ

ç°åœ¨ï¼Œæˆ‘ä»¬æ¥è®¾è®¡å¦‚ä½•åœ¨ `Tracking` çº¿ç¨‹ä¸­ï¼Œä¼˜é›…åœ°å®ç°è‡ªå®šä¹‰åæ ‡ç³»ä¸‹çš„ä½å§¿å‘å¸ƒã€‚

### 4.1. `IPoseObserver` æ¥å£å®šä¹‰
å®šä¹‰ä¸€ä¸ªçº¯è™šåŸºç±»ä½œä¸ºæ¥å£ï¼Œä»»ä½•æƒ³æ¥æ”¶ä½å§¿æ›´æ–°çš„ç±»éƒ½åº”ç»§æ‰¿å®ƒã€‚

- **`Tracking.h`**
```cpp
class IPoseObserver 
{
public:
    /**
     * @brief è™šææ„å‡½æ•° (Virtual destructor)
     * ç¡®ä¿é€šè¿‡åŸºç±»æŒ‡é’ˆåˆ é™¤æ´¾ç”Ÿç±»å¯¹è±¡æ—¶èƒ½å¤Ÿæ­£ç¡®è°ƒç”¨æ´¾ç”Ÿç±»çš„ææ„å‡½æ•°ã€‚
     */
    virtual ~IPoseObserver() = default;
    
    /**
     * @brief å½“æ–°çš„ä½å§¿å¯ç”¨æ—¶è¢«è°ƒç”¨ (Called when a new pose is available)
     * @param T_custom_world_camera ç›¸æœºåœ¨ç”¨æˆ·è‡ªå®šä¹‰ä¸–ç•Œåæ ‡ç³»ä¸‹çš„ä½å§¿ (SE3 transform: pose of the camera in the custom world coordinate system)
     * é€šå¸¸æ˜¯ Sophus::SE3f ç±»å‹ã€‚
     * @param timestamp å¸§çš„æ—¶é—´æˆ³
     */
    virtual void OnPoseUpdated(const Sophus::SE3f& T_custom_world_camera, double timestamp) = 0;
};
```

### 4.2. è§‚å¯Ÿè€…ç®¡ç†
åœ¨ `Tracking` ç±»ä¸­å®ç°è§‚å¯Ÿè€…çš„æ³¨å†Œã€æ³¨é”€å’Œå­˜å‚¨ã€‚

- **`Tracking.h` (Public methods)**
```cpp
    // æ³¨å†Œä½å§¿è§‚å¯Ÿè€…å¯¹è±¡ï¼Œç”¨äºæ¥æ”¶ç›¸æœºä½å§¿æ›´æ–°ä¿¡æ¯
    // æ”¯æŒæ³¨å†Œå¤šä¸ªè§‚å¯Ÿè€…
    void RegisterPoseObserver(IPoseObserver* pObserver);

    // å–æ¶ˆæ³¨å†Œä½å§¿è§‚å¯Ÿè€…
    void UnregisterPoseObserver(IPoseObserver* pObserver);
```
- **`Tracking.h` (Private members)**
```cpp
    std::vector<IPoseObserver*> mvpPoseObservers;
    std::mutex mMutexPoseAccess; // ç”¨äºä¿æŠ¤è§‚å¯Ÿè€…åˆ—è¡¨çš„äº’æ–¥é”
```

### 4.3. è®¾ç½®è‡ªå®šä¹‰åæ ‡ç³»å˜æ¢
æä¾›ä¸€ä¸ªæ–¹æ³•æ¥è®¾ç½®è‡ªå®šä¹‰åæ ‡ç³»ä¸ ORB-SLAM å†…éƒ¨ä¸–ç•Œåæ ‡ç³»çš„å˜æ¢å…³ç³»ã€‚

- **`Tracking.h`**
```cpp
/**
 * @brief Sets the transformation from the ORB-SLAM world to the custom world coordinate system.
 * @param T_custom_orb The transform T_custom_orb, which transforms a point from ORB-SLAM world to custom world: p_custom = T_custom_orb * p_orb.
 */
void SetCustomWorldTransform(const Sophus::SE3f& T_custom_orb);

// Private members
Sophus::SE3f mT_custom_orb; // Stores T_custom_orb
std::mutex mMutexTransform; // å¦‚æœå˜æ¢å…³ç³»å¯èƒ½åœ¨è¿è¡Œæ—¶æ”¹å˜ï¼Œåˆ™éœ€è¦äº’æ–¥é”ä¿æŠ¤
```

### 4.4. é€šçŸ¥ä¸åæ ‡å˜æ¢

è¿™æ˜¯å°†æ‰€æœ‰éƒ¨åˆ†è¿æ¥èµ·æ¥çš„å…³é”®ã€‚åœ¨ `Tracking::Track()` æ–¹æ³•çš„æœ«å°¾ï¼Œå½“è®¡ç®—å‡ºæœ‰æ•ˆä½å§¿ä¸” `mState == OK` ä¹‹åï¼Œæ‰§è¡Œé€šçŸ¥é€»è¾‘ã€‚

- **`Tracking.cc` in `Track()` method**
```cpp
   // ... tracking logic ...

   // è·Ÿè¸ªæˆåŠŸåï¼ŒmState ä¼šè¢«è®¾ç½®ä¸º OK
   // å¦‚æœæœ‰æ³¨å†Œçš„ä½å§¿è§‚å¯Ÿè€…ï¼Œåˆ™è¿›è¡Œé€šçŸ¥
   if(!mvpPoseObservers.empty() && mState == OK)
   {
       // 1. è·å–ç›¸æœºåœ¨ORB-SLAMä¸–ç•Œåæ ‡ç³»ä¸‹çš„ä½å§¿ (T_orb_c)
       //    mCurrentFrame.GetPoseInverse() è¿”å›çš„æ˜¯ mTwc, å³ T_orb_c
       const Sophus::SE3f T_orb_c = mCurrentFrame.GetPoseInverse();
       
       // 2. è®¡ç®—ç›¸æœºåœ¨è‡ªå®šä¹‰ä¸–ç•Œåæ ‡ç³»ä¸‹çš„ä½å§¿ (T_custom_c)
       //    å…¬å¼: T_custom_c = T_custom_orb * T_orb_c
       Sophus::SE3f T_custom_c;
       {
           std::unique_lock<std::mutex> lock(mMutexTransform); // ä¿æŠ¤ mT_custom_orb
           T_custom_c = mT_custom_orb * T_orb_c;
       }
       
       // 3. éå†å¹¶é€šçŸ¥æ‰€æœ‰è§‚å¯Ÿè€…
       std::unique_lock<std::mutex> lock(mMutexPoseAccess); // ä¿æŠ¤ mvpPoseObservers
       for(auto pObserver : mvpPoseObservers) {
           if(pObserver) {
               pObserver->OnPoseUpdated(T_custom_c, mCurrentFrame.mTimeStamp);
           }
       }
   }
```
> [!warning]
> **å…³äºæ‚¨ä»£ç çš„è¯´æ˜**
> æ‚¨åœ¨ä¹‹å‰ç¼–è¾‘ä¸­æä¾›çš„ä»£ç æ®µï¼Œè™½ç„¶å˜é‡å‘½åï¼ˆå¦‚ `Twc` `Tcw`ï¼‰å¯èƒ½ä¸æ ‡å‡†çº¦å®šç•¥æœ‰å‡ºå…¥ï¼Œä½†å…¶æ ¸å¿ƒæ•°å­¦é€»è¾‘ `mT_custom_orb * mCurrentFrame.GetPose().inverse()` æ˜¯å®Œå…¨æ­£ç¡®çš„ã€‚ä¸Šé¢çš„ä»£ç ç‰‡æ®µé‡‡ç”¨äº†æ›´ç¬¦åˆæƒ¯ä¾‹çš„å‘½å (`T_orb_c`) ä»¥å¢å¼ºå¯è¯»æ€§ï¼Œä½†æœ€ç»ˆè®¡ç®—ç»“æœä¸æ‚¨çš„ä»£ç æ˜¯ä¸€è‡´çš„ã€‚

---

## 5. âœ… æ•´åˆæµç¨‹ä¸ä¼˜åŒ–å»ºè®®

### 5.1. å®Œæ•´æ•°æ®æµ
1.  **å¤–éƒ¨è°ƒç”¨**: `System::TrackMonocular(image, timestamp, ...)`
2.  **è¿›å…¥è·Ÿè¸ª**: `Tracking::GrabImageMonocular` å°è£… `Frame` å¹¶è°ƒç”¨ `Tracking::Track()`ã€‚
3.  **ä½å§¿è®¡ç®—**: `Track()` å†…éƒ¨é€šè¿‡ `TrackLocalMap` ç­‰æ­¥éª¤ï¼Œè®¡ç®—å‡º `mCurrentFrame.mTcw`ã€‚
4.  **çŠ¶æ€æ£€æŸ¥**: ç¡®è®¤è·Ÿè¸ªæˆåŠŸ `mState == OK`ã€‚
5.  **åæ ‡å˜æ¢**: åœ¨ `Track()` æœ«å°¾è®¡ç®— `T_custom_c = mT_custom_orb * mCurrentFrame.mTcw.inverse()`ã€‚
6.  **å‘å¸ƒé€šçŸ¥**: éå†è§‚å¯Ÿè€…åˆ—è¡¨ï¼Œè°ƒç”¨ `OnPoseUpdated` å¹¶ä¼ é€’ `T_custom_c` å’Œæ—¶é—´æˆ³ã€‚
7.  **è¿”å›ä½å§¿**: `GrabImageMonocular` å‘æœ€åˆçš„è°ƒç”¨è€…è¿”å› `mCurrentFrame.mTcw.inverse()`ã€‚

### 5.2. ä¼˜åŒ–ä¸æ³¨æ„äº‹é¡¹
- ğŸ” **çº¿ç¨‹å®‰å…¨**: `mvpPoseObservers` å’Œ `mT_custom_orb` çš„æ‰€æœ‰è®¿é—®ï¼ˆå¢ã€åˆ ã€æ”¹ã€æŸ¥ï¼‰éƒ½å¿…é¡»ç”±äº’æ–¥é”ä¿æŠ¤ï¼Œä»¥é˜²æ­¢å¤šçº¿ç¨‹å†²çªã€‚
- âš¡ï¸ **å›è°ƒæ€§èƒ½**: `OnPoseUpdated` çš„å®ç°åº”è¯¥æ˜¯**è½»é‡çº§**çš„ã€‚é¿å…åœ¨å›è°ƒå‡½æ•°ä¸­æ‰§è¡Œä»»ä½•è€—æ—¶æ“ä½œï¼ˆå¦‚æ–‡ä»¶ I/Oã€å¤æ‚è®¡ç®—ï¼‰ï¼Œå¦åˆ™ä¼šç›´æ¥é˜»å¡ `Tracking` çº¿ç¨‹ï¼Œä¸¥é‡å½±å“ SLAM çš„å®æ—¶æ€§å’Œç¨³å®šæ€§ã€‚æ¨èçš„åšæ³•æ˜¯ï¼Œåœ¨å›è°ƒä¸­ä»…å°†ä½å§¿æ•°æ®æ‹·è´åˆ°çº¿ç¨‹å®‰å…¨çš„é˜Ÿåˆ—ä¸­ï¼Œç”±å¦ä¸€ä¸ªå·¥ä½œçº¿ç¨‹è¿›è¡Œæ¶ˆè´¹ã€‚
- ğŸ¤·â€â™‚ï¸ **è·Ÿè¸ªä¸¢å¤±å¤„ç†**: å½“ `mState` ä¸æ˜¯ `OK` æ—¶ï¼ˆä¾‹å¦‚ä¸º `LOST`ï¼‰ï¼Œ`Tracking` çº¿ç¨‹ä¸ä¼šæ›´æ–°ä½å§¿ã€‚æ­¤æ—¶ä¸åº”é€šçŸ¥è§‚å¯Ÿè€…ï¼Œæˆ–è€…å¯ä»¥æ ¹æ®åº”ç”¨éœ€æ±‚ï¼Œå‘é€ä¸€ä¸ª"æ— æ•ˆä½å§¿"çš„ç‰¹æ®Šä¿¡å·ã€‚
-  clarity **åæ ‡ç³»å®šä¹‰æ¸…æ™°**: `SetCustomWorldTransform` çš„å‚æ•° `T_custom_orb` çš„å˜æ¢æ–¹å‘ (`ORB -> Custom` è¿˜æ˜¯ `Custom -> ORB`) å¿…é¡»æœ‰æ¸…æ™°çš„æ–‡æ¡£å’Œä»£ç æ³¨é‡Šï¼Œä»¥é¿å…ä½¿ç”¨è€…æ··æ·†ã€‚æ ¹æ®æˆ‘ä»¬çš„æ¨å¯¼ï¼Œå®ƒåº”è¯¥æ˜¯ `T_custom_orb`ã€‚

---

## 6. ğŸ’¡ å®ä¾‹ï¼šåœ¨ `mono_euroc.cc` ä¸­ä½¿ç”¨

ç†è®ºå’Œè®¾è®¡æœ€ç»ˆéœ€è¦è½å®åœ¨ä»£ç ä¸­ã€‚`Examples/Monocular/mono_euroc.cc` æä¾›äº†ä¸€ä¸ªç»ä½³çš„èŒƒä¾‹ï¼Œå±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨æˆ‘ä»¬è®¾è®¡çš„è§‚å¯Ÿè€…æ¨¡å¼æ¥è®°å½•è‡ªå®šä¹‰åæ ‡ç³»ä¸‹çš„ç›¸æœºè½¨è¿¹ã€‚

### 6.1. åˆ›å»ºå…·ä½“çš„è§‚å¯Ÿè€… `TUMFormatTrajectoryRecorder`
è¿™æ˜¯è§‚å¯Ÿè€…æ¨¡å¼çš„å®è·µæ ¸å¿ƒï¼šåˆ›å»ºä¸€ä¸ªç»§æ‰¿è‡ª `IPoseObserver` çš„å…·ä½“ç±»ã€‚

- **`Examples/Monocular/mono_euroc.cc`**
```cpp
// æŒ‰ç…§ORB-SLAM3çš„TUMæ ¼å¼ï¼Œè½¨è¿¹è®°å½•
class TUMFormatTrajectoryRecorder : public ORB_SLAM3::IPoseObserver
{
private:
    std::ofstream mOutputFile; // æ–‡ä»¶æµï¼Œç”¨äºå†™å…¥è½¨è¿¹æ•°æ®
    // ... å…¶ä»–æˆå‘˜ ...

public:
    TUMFormatTrajectoryRecorder(const std::string& filename, ...);
    ~TUMFormatTrajectoryRecorder();
    
    // æ ¸å¿ƒï¼šå®ç°åŸºç±»çš„çº¯è™šå‡½æ•°
    void OnPoseUpdated(const Sophus::SE3f& T_custom_world_camera, double timestamp) override 
    {
        if (!mOutputFile.is_open()) return;        
        
        // è·å–å¹³ç§»å‘é‡
        Eigen::Vector3f twc = T_custom_world_camera.translation();
        // è·å–å•ä½å››å…ƒæ•°
        Eigen::Quaternionf q = T_custom_world_camera.unit_quaternion();
        
        // ä»¥TUMæ ¼å¼å°† æ—¶é—´æˆ³ã€å¹³ç§»ã€æ—‹è½¬ï¼ˆå››å…ƒæ•°ï¼‰å†™å…¥æ–‡ä»¶
        mOutputFile << std::setprecision(6) << timestamp << " "
                    << std::setprecision(9) 
                    << twc.x() << " " << twc.y() << " " << twc.z() << " "
                    << q.w() << " " << q.x() << " " << q.y() << " " << q.z() 
                    << std::endl;        
    }
};
```
è¿™ä¸ªç±» `TUMFormatTrajectoryRecorder` çš„å”¯ä¸€èŒè´£å°±æ˜¯å°†æ¥æ”¶åˆ°çš„ä½å§¿ `T_custom_world_camera` æ ¼å¼åŒ–å¹¶å†™å…¥æ–‡ä»¶ã€‚è¿™å®Œå…¨ç¬¦åˆæˆ‘ä»¬å¯¹å›è°ƒå‡½æ•°"è½»é‡çº§"çš„è¦æ±‚ã€‚

### 6.2. åœ¨ `main` å‡½æ•°ä¸­è®¾ç½®å’Œæ³¨å†Œè§‚å¯Ÿè€…
åœ¨ä¸»ç¨‹åºå…¥å£ï¼Œæˆ‘ä»¬éœ€è¦å®Œæˆæ‰€æœ‰è®¾ç½®å·¥ä½œã€‚

- **`Examples/Monocular/mono_euroc.cc`**
```cpp
int main(int argc, char **argv)
{  
    // ... åˆå§‹åŒ–SLAMç³»ç»Ÿ ...
    ORB_SLAM3::System SLAM(argv[1], argv[2], ORB_SLAM3::System::MONOCULAR, true);

    // 1. è·å–å¯¹ Tracking å¯¹è±¡çš„å¼•ç”¨
    ORB_SLAM3::Tracking* pTracker = SLAM.GetTracker();
    if (pTracker) {

        // 2. å®šä¹‰è‡ªå®šä¹‰åæ ‡ç³»åˆ°ORBåæ ‡ç³»çš„å˜æ¢ T_custom_orb
        //    å‡è®¾ORBåæ ‡ç³»åŸç‚¹åœ¨è‡ªå®šä¹‰ä¸–ç•Œåæ ‡çš„(1.5, 2.2, 0)ï¼Œä¸”å§¿æ€ä¸€è‡´
        Eigen::Vector3f t_custom_orb_translation(1.5, 2.2, 0);
        Eigen::Matrix3f R_custom_orb = Eigen::Matrix3f::Identity();
        Sophus::SE3f T_custom_orb(R_custom_orb, t_custom_orb_translation);
        
        // 3. è®¾ç½®å˜æ¢
        pTracker->SetCustomWorldTransform(T_custom_orb);

        // 4. åˆ›å»ºè§‚å¯Ÿè€…å®ä¾‹
        std::string customTrajFile = "f_custom_"+ std::string(argv[5]) + ".txt";
        TUMFormatTrajectoryRecorder* pTrajectoryRecorder = new TUMFormatTrajectoryRecorder(customTrajFile, false);
        
        // 5. æ³¨å†Œè§‚å¯Ÿè€…
        pTracker->RegisterPoseObserver(pTrajectoryRecorder);
        
        std::cout << "ğŸ”„ å·²æ³¨å†Œè‡ªå®šä¹‰åæ ‡ç³»è½¨è¿¹è®°å½•å™¨..." << std::endl;
    } 
    
    // ... ä¸»å¾ªç¯ï¼Œè°ƒç”¨ SLAM.TrackMonocular(...) ...
    for(int ni=0; ni<nImages[seq]; ni++)
    {
        // ...
        SLAM.TrackMonocular(im, tframe); 
        // ...
    }

    // ... ç»“æŸ ...
    SLAM.Shutdown();
    
    return 0;
}
```
è¿™æ®µä»£ç æ¸…æ™°åœ°å±•ç¤ºäº†æ•´ä¸ªæµç¨‹ï¼š
1.  **è·å–Tracker**: ä» `System` å¯¹è±¡ä¸­è·å– `Tracking` å¯¹è±¡çš„æŒ‡é’ˆã€‚
2.  **å®šä¹‰å˜æ¢**: åˆ›å»ºä¸€ä¸ª `Sophus::SE3f` å®ä¾‹æ¥è¡¨ç¤º `T_custom_orb`ã€‚
3.  **è®¾ç½®å˜æ¢**: è°ƒç”¨ `SetCustomWorldTransform` å°†å…¶ä¼ é€’ç»™ `Tracking` æ¨¡å—ã€‚
4.  **å®ä¾‹åŒ–è§‚å¯Ÿè€…**: åˆ›å»º `TUMFormatTrajectoryRecorder` å¯¹è±¡ï¼Œå®ƒä¼šè‡ªåŠ¨æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ç”¨äºå†™å…¥ã€‚
5.  **æ³¨å†Œè§‚å¯Ÿè€…**: è°ƒç”¨ `RegisterPoseObserver` å°†å…¶"æŒ‚è½½"åˆ° `Tracking` çº¿ç¨‹çš„é€šçŸ¥åˆ—è¡¨ä¸Šã€‚

æ­¤åï¼Œæ¯æ¬¡ `Tracking` çº¿ç¨‹æˆåŠŸè·Ÿè¸ªä¸€å¸§å›¾åƒï¼Œ`pTrajectoryRecorder->OnPoseUpdated(...)` å°±ä¼šè¢«è‡ªåŠ¨è°ƒç”¨ï¼Œä»è€Œå°†è‡ªå®šä¹‰åæ ‡ç³»ä¸‹çš„ä½å§¿å®æ—¶è®°å½•åˆ°æ–‡ä»¶ä¸­ã€‚